<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HTML Tables to District-wise JSON ZIP</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: sans-serif; padding:20px; background:#f7f7f7; display:flex; justify-content:center; }
.container { background:#fff; padding:25px; border-radius:8px; max-width:600px; width:100%; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
input,button { width:100%; padding:12px; margin-bottom:15px; font-size:1rem; border-radius:5px; }
button { background:#2e7d32; color:white; border:none; cursor:pointer; font-weight:700; }
button:hover { background:#1b4d20; }
pre { background:#eee; padding:15px; border-radius:5px; min-height:100px; overflow:auto; }
</style>
</head>
<body>
<div class="container">
  <h2>HTML ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</h2>
  <input type="file" id="fileInput" accept=".xls,.xlsx,.html,.htm" multiple />
  <button id="btnProcess">Convert & Download ZIP</button>
  <pre id="log"></pre>
</div>

<script>
(() => {
  const fileInput = document.getElementById("fileInput");
  const btnProcess = document.getElementById("btnProcess");
  const logEl = document.getElementById("log");

  const stateJson = { "19":["‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂","madhya_pradesh"],"20":["‡§Æ‡§π‡§æ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞","maharashtra"] /* add rest */ };
  const distJson = { "19001":["‡§Ü‡§ó‡§∞ ‡§Æ‡§æ‡§≤‡§µ‡§æ","agar_malwa"],"19009":["‡§≠‡•ã‡§™‡§æ‡§≤","bhopal"] /* add rest */ };
  const mandiJson = { "19001001":["‡§Ü‡§ó‡§∞ ‡§Æ‡§Ç‡§°‡•Ä (‡§´‡§≤-‡§∏‡§¨‡•ç‡§ú‡•Ä)","agar_mandi_fv"],"19001002":["‡§¨‡§°‡§º‡•ã‡§¶ ‡§Æ‡§Ç‡§°‡•Ä (‡§´‡§≤-‡§∏‡§¨‡•ç‡§ú‡•Ä)","badod_mandi_fv"] /* add rest */ };
  const commodityJson = { "001":"‡§ó‡•á‡§π‡•Ç‡§Å","101":"‡§¨‡§æ‡§∏‡§Æ‡§§‡•Ä" /* add rest */ };
  const varietyJson = { "00101":{"cid":"001","n":"‡§∂‡§∞‡§¨‡§§‡•Ä"},"10101":{"cid":"101","n":"‡§¨‡§æ‡§∏‡§Æ‡§§‡•Ä"} /* add rest */ };
  const gradeJson = { "01":"‡§ó‡•ç‡§∞‡•á‡§° - A","02":"FAQ" };

  function extractStateName(titleText){
    titleText = titleText.replace(/<[^>]*>/g,"").trim();
    const stateMatch = titleText.match(/from\s+(.+?)\s+from/i);
    return stateMatch && stateMatch[1] ? stateMatch[1].trim() : "Unknown_State";
  }

  function parseHTML(content,filename){
    const parser = new DOMParser();
    const doc = parser.parseFromString(content,"text/html");
    const table = doc.querySelector("table");
    if(!table) throw new Error(`Table not found in ${filename}`);
    return [...table.querySelectorAll("tr")].map(tr=>[...tr.querySelectorAll("th,td")].map(td=>td.textContent.trim()));
  }

  btnProcess.addEventListener("click", async ()=>{
    const files = fileInput.files;
    if(!files.length){ alert("‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç"); return; }

    logEl.textContent = "üïê Processing...\n";
    const zip = new JSZip();
    const missedRows = [];

    for(const file of files){
      logEl.textContent += `\nüìÇ ${file.name}`;
      const content = await file.text();
      let tableRows;
      try { tableRows = parseHTML(content,file.name); } 
      catch(err){ logEl.textContent += `\n‚ùå ${err.message}`; continue; }

      const titleText = content.slice(0,content.indexOf("<table"));
      const stateName = extractStateName(titleText);
      const stateFolder = zip.folder(stateName.replace(/\s+/g,"_").toLowerCase());

      const headers = ["date","mandi_id","commodity_id","variety_id","grade_id","min_price","max_price","modal_price","arrival_quintal","arrival_bori"];
      const districtDataMap = {}; // district-wise

      tableRows.slice(1).forEach((row,index)=>{
        if(row.length<5) return;
        const date = row[9] || "";
        const districtName = row[1];
        const mandiName = row[2];
        const commodityName = row[3];
        const varietyName = row[4];
        const gradeName = row[5];
        const minPrice = row[6] || 0;
        const maxPrice = row[7] || 0;
        const modalPrice = row[8] || 0;

        // Mapping IDs
        let reason = "";
        const stateId = Object.keys(stateJson).find(k=>stateJson[k][0]===stateName);
        if(!stateId){ reason="State Missing"; missedRows.push({State:stateName,Row:index+1,District:districtName,Mandi:mandiName,Commodity:commodityName,Reason:reason}); return; }

        const distId = Object.keys(distJson).find(k=>distJson[k][0]===districtName);
        if(!distId){ reason="District Missing"; missedRows.push({State:stateName,Row:index+1,District:districtName,Mandi:mandiName,Commodity:commodityName,Reason:reason}); return; }

        const mandiId = Object.keys(mandiJson).find(k=>mandiJson[k][0]===mandiName);
        if(!mandiId){ reason="Mandi Missing"; missedRows.push({State:stateName,Row:index+1,District:districtName,Mandi:mandiName,Commodity:commodityName,Reason:reason}); return; }

        const commodityId = Object.keys(commodityJson).find(k=>commodityJson[k]===commodityName);
        if(!commodityId){ reason="Commodity Missing"; missedRows.push({State:stateName,Row:index+1,District:districtName,Mandi:mandiName,Commodity:commodityName,Reason:reason}); return; }

        const varietyId = Object.keys(varietyJson).find(k=>varietyJson[k].n===varietyName && varietyJson[k].cid===commodityId) || "0";
        const gradeId = Object.keys(gradeJson).find(k=>gradeJson[k]===gradeName) || "0";

        if(!districtDataMap[districtName]) districtDataMap[districtName] = [];
        districtDataMap[districtName].push([date,mandiId,commodityId,varietyId,gradeId,minPrice,maxPrice,modalPrice,0,0]);
      });

      // Create district-wise files
      for(const district in districtDataMap){
        const distFolder = stateFolder.folder(district.replace(/\s+/g,"_").toLowerCase());
        const distFileName = `${district.replace(/\s+/g,"_").toLowerCase()}_prices.json`;
        distFolder.file(distFileName, JSON.stringify({headers:headers,rows:districtDataMap[district]},null,2));
      }

      logEl.textContent += `\n‚úÖ ${file.name} done`;
    }

    // Generate ZIP
    const blob = await zip.generateAsync({type:"blob"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "mandi_data_distwise.zip";
    a.click();
    logEl.textContent += "\n\nüì¶ ZIP downloaded";

    // Missed rows Excel
    if(missedRows.length){
      const wb = XLSX.utils.book_new();
      const wsData = [["State","Row Number","District","Mandi","Commodity","Reason"],
                      ...missedRows.map(r=>[r.State,r.Row,r.District||"0",r.Mandi||"0",r.Commodity||"0",r.Reason])];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb,ws,"Missed Rows");
      XLSX.writeFile(wb,"missed_rows.xlsx");
      logEl.textContent += "\n‚úÖ Missed rows Excel downloaded";
    }
  });
})();
</script>
</body>
</html>
