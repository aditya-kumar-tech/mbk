<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>SheopurMBK ‡§°‡•á‡§ü‡§æ</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
h2, h3 { color: #333; }
table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 10px; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: center; }
th { background: #4CAF50; color: white; }
tr:nth-child(even) { background: #f9f9f9; }
input, select, button { padding: 6px; margin: 3px; border: 1px solid #ccc; border-radius: 4px; }
button { background: #4CAF50; color: white; border: none; cursor: pointer; }
button:hover { background: #45a049; }
tfoot td { font-weight: bold; background: #eee; }
.action-btn { margin: 0 2px; padding: 4px 8px; font-size: 12px; }
.editing { background: #fffae6; }
.form-box {
  background: #fff; padding: 10px; border: 1px solid #ccc; 
  border-radius: 5px; margin-bottom: 15px;
}
</style>
</head>
<body>

<h2>SheopurMBK ‡§°‡•á‡§ü‡§æ</h2>

<!-- üìå New Entry Form -->
<div class="form-box">
  <h3>‡§®‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä</h3>
  <form id="entryForm">
    ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: <input type="date" id="‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï" required>  
    ‡§ú‡§ø‡§®‡•ç‡§∏: <select id="‡§ú‡§ø‡§®‡•ç‡§∏"></select><br>
    ‡§™‡§∞‡•ç‡§ö‡•á ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: <input type="text" id="‡§™‡§∞‡•ç‡§ö‡•á ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ">
    ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§¨‡•ã‡§∞‡•Ä): <input type="number" id="‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§¨‡•ã‡§∞‡•Ä)" step="0.01">
    ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ï‡•Å.): <input type="number" id="‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ï‡•Å.)" step="0.01"><br>
    ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡•ç‡§§‡§Æ: <input type="number" id="‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡•ç‡§§‡§Æ" step="0.01">
    ‡§Æ‡•â‡§°‡§≤: <input type="number" id="‡§Æ‡•â‡§°‡§≤" step="0.01">
    ‡§Ö‡§ß‡§ø‡§ï‡§§‡•ç‡§§‡§Æ: <input type="number" id="‡§Ö‡§ß‡§ø‡§ï‡§§‡•ç‡§§‡§Æ" step="0.01"><br>
    <button type="submit">Save</button>
  </form>
</div>

<label>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç:</label>
<input type="date" id="searchDate">
<button onclick="loadFiltered()">‡§ñ‡•ã‡§ú‡•á‡§Ç</button>
<button onclick="loadAll()">‡§∏‡§≠‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç</button>

<h3>‡§°‡•á‡§ü‡§æ ‡§∏‡•Ç‡§ö‡•Ä</h3>
<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th><th>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï</th><th>‡§ú‡§ø‡§®‡•ç‡§∏</th><th>‡§™‡§∞‡•ç‡§ö‡•á ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</th>
      <th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§¨‡•ã‡§∞‡•Ä)</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ï‡•Å.)</th>
      <th>‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡•ç‡§§‡§Æ</th><th>‡§Æ‡•â‡§°‡§≤</th><th>‡§Ö‡§ß‡§ø‡§ï‡§§‡•ç‡§§‡§Æ</th><th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="4">‡§ï‡•Å‡§≤</td>
      <td id="totalBori">0</td>
      <td id="totalKu">0</td>
      <td colspan="4"></td>
    </tr>
  </tfoot>
</table>

<script>
const api = "https://script.google.com/macros/s/AKfycbwTeA-NGZDLF6kOpukq4xdFusnrW2YDdtqgzmhkIKX0eCjWl0N5wVbvjtpy3vPlh89m/exec"; // ‡§Ø‡§π‡§æ‡§Ç ‡§Ö‡§™‡§®‡§æ Web App URL ‡§°‡§æ‡§≤‡•á‡§Ç

// -------- Load JINS Dropdown from Sheet --------
async function loadJinsList() {
  const res = await fetch(`${api}?action=getJinsList`);
  const jinsArray = await res.json();
  const jinsSelect = document.getElementById("‡§ú‡§ø‡§®‡•ç‡§∏");
  jinsSelect.innerHTML = "";
  jinsArray.forEach(jins => {
    const opt = document.createElement("option");
    opt.value = jins;
    opt.textContent = jins;
    jinsSelect.appendChild(opt);
  });
}

// -------- Load All Data --------
async function loadAll() {
  const res = await fetch(api);
  const data = await res.json();
  renderTable(data);
}

// -------- Load Filtered Data --------
async function loadFiltered() {
  const date = document.getElementById("searchDate").value;
  if (!date) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï ‡§ö‡•Å‡§®‡•á‡§Ç");
  const res = await fetch(`${api}?action=getDataByDate&date=${encodeURIComponent(date)}`);
  const data = await res.json();
  renderTable(data);
}

// -------- Format Date Indian --------
function formatDateIndian(dateStr) {
  if(!dateStr) return "";
  let dateObj = new Date(dateStr);
  if (isNaN(dateObj)) return dateStr;
  return dateObj.toLocaleDateString('en-GB');
}

// -------- Render Table --------
function renderTable(data) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  let totalBori = 0;
  let totalKu = 0;

  data.forEach(row => {
    totalBori += Number(row["‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§¨‡•ã‡§∞‡•Ä)"]) || 0;
    totalKu += Number(row["‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ï‡•Å.)"]) || 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${formatDateIndian(row["‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï"])}</td>
      <td>${row["‡§ú‡§ø‡§®‡•ç‡§∏"]}</td>
      <td>${row["‡§™‡§∞‡•ç‡§ö‡•á ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ"]}</td>
      <td>${row["‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§¨‡•ã‡§∞‡•Ä)"]}</td>
      <td>${row["‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ï‡•Å.)"]}</td>
      <td>${row["‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡•ç‡§§‡§Æ"]}</td>
      <td>${row["‡§Æ‡•â‡§°‡§≤"]}</td>
      <td>${row["‡§Ö‡§ß‡§ø‡§ï‡§§‡•ç‡§§‡§Æ"]}</td>
      <td>
        <button class="action-btn" onclick='editRow(this)'>Edit</button>
        <button class="action-btn" style="background:#d9534f" onclick='deleteRow("${row.id}")'>Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("totalBori").innerText = totalBori;
  document.getElementById("totalKu").innerText = totalKu;
}

// -------- Inline Edit --------
function editRow(btn) {
  const tr = btn.closest("tr");
  if (tr.classList.contains("editing")) return;
  tr.classList.add("editing");

  for (let i = 1; i <= 8; i++) { 
    let cell = tr.cells[i];
    let val = cell.innerText;
    if (i === 1) { // date
      let parts = val.split("/");
      if (parts.length === 3) {
        val = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
      }
      cell.innerHTML = `<input type="date" value="${val}">`;
    } else {
      cell.innerHTML = `<input type="text" value="${val}">`;
    }
  }
  btn.innerText = "Save";
  btn.onclick = () => saveRow(tr, btn);
}

// -------- Save Edited Row --------
async function saveRow(tr, btn) {
  const id = tr.cells[0].innerText;
  const record = {
    id: id,
    "‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï": tr.cells[1].querySelector("input").value,
    "‡§ú‡§ø‡§®‡•ç‡§∏": tr.cells[2].querySelector("input").value,
    "‡§™‡§∞‡•ç‡§ö‡•á ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ": tr.cells[3].querySelector("input").value,
    "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§¨‡•ã‡§∞‡•Ä)": tr.cells[4].querySelector("input").value,
    "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ï‡•Å.)": tr.cells[5].querySelector("input").value,
    "‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡•ç‡§§‡§Æ": tr.cells[6].querySelector("input").value,
    "‡§Æ‡•â‡§°‡§≤": tr.cells[7].querySelector("input").value,
    "‡§Ö‡§ß‡§ø‡§ï‡§§‡•ç‡§§‡§Æ": tr.cells[8].querySelector("input").value
  };

  const res = await fetch(`${api}?action=update&data=${encodeURIComponent(JSON.stringify(record))}`);
  const result = await res.json();
  if (result.status === "success") {
    tr.classList.remove("editing");
    loadAll();
  } else {
    alert("Error updating data");
  }
}

// -------- Delete Row --------
async function deleteRow(id) {
  if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à delete ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;
  const res = await fetch(`${api}?action=delete&id=${id}`);
  const result = await res.json();
  if (result.status === "success") {
    loadAll();
  } else {
    alert("Error deleting");
  }
}

// -------- Handle New Entry Form Submit --------
document.getElementById("entryForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const record = {};
  ["‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","‡§ú‡§ø‡§®‡•ç‡§∏","‡§™‡§∞‡•ç‡§ö‡•á ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ","‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§¨‡•ã‡§∞‡•Ä)","‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ï‡•Å.)","‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡•ç‡§§‡§Æ","‡§Æ‡•â‡§°‡§≤","‡§Ö‡§ß‡§ø‡§ï‡§§‡•ç‡§§‡§Æ"].forEach(id => {
    record[id] = document.getElementById(id).value;
  });

  const res = await fetch(`${api}?action=add&data=${encodeURIComponent(JSON.stringify(record))}`);
  const result = await res.json();
  if (result.status === "success") {
    document.getElementById("entryForm").reset();
    document.getElementById("‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï").value = new Date().toISOString().split('T')[0];
    loadAll();
  } else {
    alert("Error saving data");
  }
});

// -------- Init --------
document.getElementById("‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï").value = new Date().toISOString().split('T')[0]; // default today
loadJinsList();
loadAll();
</script>
</body>
</html>
