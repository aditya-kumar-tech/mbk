<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>SheopurMBK - Entry & View/Edit</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 20px; }
h2, h3 { color: #333; }
table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 8px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #4CAF50; color: white; }
tr:nth-child(even) { background: #f9f9f9; }
input, select, button { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
button { cursor: pointer; }
.edit-btn { background: orange; color: #fff; border: none; padding: 4px 8px; }
.delete-btn { background: red; color: #fff; border: none; padding: 4px 8px; }
.save-btn { background: green; color: #fff; border: none; padding: 6px 12px; }
.form-box { background: #fff; padding: 12px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; }
tfoot td { font-weight: bold; background: #eee; }
.spinner { display:none; text-align:center; margin:10px; font-weight:bold; }
.form-box form { display: flex; flex-direction: column; gap: 8px; }
@media (min-width: 768px) {
  .form-box form { flex-direction: row; flex-wrap: wrap; }
  .form-box form > * { flex: 1 1 150px; }
}
</style>
</head>
<body>

<h2>SheopurMBK - नई एंट्री</h2>
<div class="form-box">
  <form id="entryForm">
    <input type="date" id="दिनांक" required>
    <select id="जिन्स" required></select>
    <input type="number" id="पर्चे संख्या" placeholder="पर्चे संख्या" required>
    <input type="number" id="मात्रा (बोरी)" placeholder="मात्रा (बोरी)" step="0.01" required>
    <input type="number" id="मात्रा (कु.)" placeholder="मात्रा (कु.)" step="0.01" required>
    <input type="number" id="न्यूनत्तम" placeholder="न्यूनत्तम" step="0.01" required>
    <input type="number" id="मॉडल" placeholder="मॉडल" step="0.01" required>
    <input type="number" id="अधिकत्तम" placeholder="अधिकत्तम" step="0.01" required>
    <button type="button" onclick="addToStaging()" class="save-btn">टेबल में जोड़ें</button>
  </form>
</div>

<h3>लोकल Staging</h3>
<table id="stagingTable">
  <thead>
    <tr>
      <th>दिनांक</th><th>जिन्स</th><th>पर्चे संख्या</th>
      <th>मात्रा (बोरी)</th><th>मात्रा (कु.)</th>
      <th>न्यूनत्तम</th><th>मॉडल</th><th>अधिकत्तम</th><th>एक्शन</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="2">कुल</td>
      <td id="stgParche">0</td>
      <td id="stgBori">0</td>
      <td id="stgKu">0</td>
      <td colspan="4"></td>
    </tr>
  </tfoot>
</table>
<br>
<button onclick="submitBulk()" class="save-btn">Bulk Save to Google Sheet</button>
<hr>

<h2>डेटा व्यू / एडिट</h2>
<div class="form-box">
  <label>जिन्स:</label>
  <select id="filterJins"><option value="">सभी</option></select>
  <label>एक तारीख:</label><input type="date" id="viewDate">
  <label>से:</label><input type="date" id="startDate">
  <label>तक:</label><input type="date" id="endDate">
  <button onclick="loadByDate()">तारीख से लोड</button>
  <button onclick="loadByFilters()">फिल्टर से लोड</button>
  <button onclick="loadAllData()">सभी डेटा</button>
  <input type="text" id="localSearch" placeholder="लोकल सर्च...">
</div>

<div id="spinner" class="spinner">⏳ लोड हो रहा है...</div>

<table id="viewTable">
  <thead>
    <tr>
      <th>ID</th><th>दिनांक</th><th>जिन्स</th><th>पर्चे संख्या</th>
      <th>मात्रा (बोरी)</th><th>मात्रा (कु.)</th>
      <th>न्यूनत्तम</th><th>मॉडल</th><th>अधिकत्तम</th><th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="3">कुल</td>
      <td id="viewParche">0</td>
      <td id="viewBori">0</td>
      <td id="viewKu">0</td>
      <td colspan="4"></td>
    </tr>
  </tfoot>
</table>

<script>
const api = "https://script.google.com/macros/s/AKfycby8ka5wnyIWJDbzKz4ypaQ8XOUkIKWknmYZ3VfKGE3bP4RgPuzclsQPimk50eDLDi8S/exec"; 
let stagingData = [];
let editIndex = -1;

function showSpinner(){document.getElementById("spinner").style.display="block";}
function hideSpinner(){document.getElementById("spinner").style.display="none";}

// Init – सिर्फ जिन्स लिस्ट लोड होगी
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("दिनांक").value = new Date().toISOString().split('T')[0];
  loadJinsList();
});

// ---------- जिन्स लिस्ट ----------
async function loadJinsList() {
  try {
    const res = await fetch(`${api}?action=getJinsList`);
    const jinsArray = await res.json();
    const jinsSelect = document.getElementById("जिन्स");
    const filterSelect = document.getElementById("filterJins");
    jinsSelect.innerHTML = "";
    filterSelect.innerHTML = "<option value=''>सभी</option>";
    jinsArray.forEach(jins => {
      const opt1 = document.createElement("option");
      opt1.value = jins; opt1.textContent = jins;
      jinsSelect.appendChild(opt1);
      const opt2 = document.createElement("option");
      opt2.value = jins; opt2.textContent = jins;
      filterSelect.appendChild(opt2);
    });
  } catch (err) { console.error(err); }
}

// ---------- Entry Add ----------
function addToStaging(){
  const fields = ["दिनांक","जिन्स","पर्चे संख्या","मात्रा (बोरी)","मात्रा (कु.)","न्यूनत्तम","मॉडल","अधिकत्तम"];
  for (let id of fields) {
    const el = document.getElementById(id);
    if (!el.value.trim()) { alert(`${id} खाली नहीं हो सकता`); el.focus(); return; }
  }
  const record = {};
  fields.forEach(id => record[id] = document.getElementById(id).value);
  if (editIndex === -1) {
    stagingData.push(record); 
  } else { 
    stagingData[editIndex] = record; 
    editIndex = -1; 
  }
  renderStaging();
  document.getElementById("entryForm").reset();
  document.getElementById("दिनांक").value = new Date().toISOString().split('T')[0];
}

function renderStaging(){
  const tb = document.querySelector("#stagingTable tbody");
  tb.innerHTML = "";
  let totP=0,totB=0,totK=0;
  
  stagingData.forEach((r,i)=>{
    totP += Number(r["पर्चे संख्या"]) || 0;
    totB += Number(r["मात्रा (बोरी)"]) || 0;
    totK += Number(r["मात्रा (कु.)"]) || 0;
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatDate(r["दिनांक"])}</td>
      <td>${r["जिन्स"]}</td>
      <td>${r["पर्चे संख्या"]}</td>
      <td>${r["मात्रा (बोरी)"]}</td>
      <td>${r["मात्रा (कु.)"]}</td>
      <td>${r["न्यूनत्तम"]}</td>
      <td>${r["मॉडल"]}</td>
      <td>${r["अधिकत्तम"]}</td>
      <td>
        <button class="edit-btn" onclick="editLocal(${i})">Edit</button>
        <button class="delete-btn" onclick="delLocal(${i})">Del</button>
      </td>
    `;
    tb.appendChild(row);
  });
  
  document.getElementById("stgParche").innerText = totP;
  document.getElementById("stgBori").innerText = totB;
  document.getElementById("stgKu").innerText = totK;
}

function editLocal(i){
  const r = stagingData[i];
  ["दिनांक","जिन्स","पर्चे संख्या","मात्रा (बोरी)","मात्रा (कु.)","न्यूनत्तम","मॉडल","अधिकत्तम"].forEach(id => {
    document.getElementById(id).value = r[id];
  });
  editIndex = i;
}

function delLocal(i){ 
  if(confirm("हटाएं?")){ 
    stagingData.splice(i,1); 
    renderStaging(); 
  } 
}

async function submitBulk(){
  if(stagingData.length === 0){ alert("कुछ जोड़ें पहले"); return; }
  showSpinner();
  try {
    const res = await fetch(`${api}?action=bulkAdd&data=${encodeURIComponent(JSON.stringify(stagingData))}`);
    const result = await res.json();
    hideSpinner();
    if(result.status === "success"){ 
      alert(`${result.count} rows saved!`); 
      stagingData = []; 
      renderStaging(); 
    } else { 
      alert("Error: " + result.message); 
    }
  } catch(err) {
    hideSpinner();
    alert("Network Error: " + err.message);
  }
}

// ---------- View/Edit Data ----------
async function loadAllData(){
  showSpinner();
  try {
    const res = await fetch(api);
    const data = await res.json();
    hideSpinner();
    renderViewTable(data);
  } catch(err) {
    hideSpinner();
    alert("Error loading data: " + err.message);
  }
}

async function loadByDate(){
  const date = document.getElementById("viewDate").value;
  if(!date){ alert("कृपया डेट चुनें"); return; }
  showSpinner();
  try {
    const res = await fetch(`${api}?action=getDataByDate&date=${encodeURIComponent(date)}`);
    const data = await res.json();
    hideSpinner();
    renderViewTable(data);
  } catch(err) {
    hideSpinner();
    alert("Error loading data: " + err.message);
  }
}

async function loadByFilters(){
  const jins = document.getElementById("filterJins").value.trim();
  const from = document.getElementById("startDate").value || "";
  const to   = document.getElementById("endDate").value || "";

 let url = `${api}?action=getDataByFilter`
        + `&from=${encodeURIComponent(from)}`
        + `&to=${encodeURIComponent(to)}`;
if (jins) url += `&jins=${encodeURIComponent(jins)}`;


  console.log("Filter API Call:", url);
  showSpinner();
  try {
    const res = await fetch(url);
    const data = await res.json();
    hideSpinner();
    renderViewTable(data);
  } catch(err) {
    hideSpinner();
    alert("Error loading filtered data: " + err.message);
  }
}

function renderViewTable(data){
  const tb = document.querySelector("#viewTable tbody");
  tb.innerHTML = "";
  let totalParche = 0, totalBori = 0, totalKu = 0;
  
  if(Array.isArray(data)) {
    data.forEach(row => {
      totalParche += Number(row["पर्चे संख्या"]) || 0;
      totalBori   += Number(row["मात्रा (बोरी)"]) || 0;
      totalKu     += Number(row["मात्रा (कु.)"]) || 0;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.id}</td>
        <td>${formatDate(row["दिनांक"])}</td>
        <td>${row["जिन्स"]}</td>
        <td>${row["पर्चे संख्या"]}</td>
        <td>${row["मात्रा (बोरी)"]}</td>
        <td>${row["मात्रा (कु.)"]}</td>
        <td>${row["न्यूनत्तम"]}</td>
        <td>${row["मॉडल"]}</td>
        <td>${row["अधिकत्तम"]}</td>
        <td>
          <button class="edit-btn" onclick='editViewRow(${JSON.stringify(row).replace(/'/g, "&apos;")})'>Edit</button>
          <button class="delete-btn" onclick='deleteViewRow("${row.id}")'>Delete</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }
  
  document.getElementById("viewParche").innerText = totalParche;
  document.getElementById("viewBori").innerText   = totalBori;
  document.getElementById("viewKu").innerText     = totalKu;
}

// ---------- Local Search ----------
document.getElementById("localSearch").addEventListener("input", function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll("#viewTable tbody tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(q) ? "" : "none";
  });
});

function editViewRow(row){
  ["दिनांक","जिन्स","पर्चे संख्या","मात्रा (बोरी)","मात्रा (कु.)","न्यूनत्तम","मॉडल","अधिकत्तम"]
    .forEach(id => document.getElementById(id).value = row[id]);
  stagingData.push(row);
  renderStaging();
}

async function deleteViewRow(id){
  if(!confirm("Delete?")) return;
  showSpinner();
  try {
    const res = await fetch(`${api}?action=delete&id=${id}`);
    const result = await res.json();
    hideSpinner();
    if(result.status === "success"){ 
      alert("Deleted successfully!"); 
      // Reload current view
      const currentView = document.getElementById("viewTable").querySelector("tbody").children.length;
      if(currentView > 0) {
        loadAllData(); // या जो भी last filter था उसे reload करें
      }
    } else {
      alert("Delete failed: " + result.message);
    }
  } catch(err) {
    hideSpinner();
    alert("Error deleting: " + err.message);
  }
}

function formatDate(d){
  if(!d) return "";
  let dt = new Date(d);
  if(isNaN(dt)) return d;
  return dt.toLocaleDateString('en-GB');
}
</script>
</body>
</html>
