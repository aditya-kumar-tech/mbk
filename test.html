<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mandi Data Entry - Editable</title>
<style>
body { font-family: Arial; padding:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; table-layout:fixed; }
th, td { border:1px solid #ccc; padding:5px; text-align:center; word-wrap:break-word; }
input, select { width:100%; padding:5px; box-sizing:border-box; font-size:14px; }
button { padding:6px 12px; margin:5px 0; font-size:14px; }
.row-btn { cursor:pointer; color:red; font-weight:bold; }
@media(max-width:600px){
  table, th, td, input, select, button { font-size:12px; }
  th, td { padding:3px; }
}
</style>
</head>
<body>

<h2>मंडी डेटा एंट्री / संपादन</h2>

<label for="entryDate">दिनांक चुने:</label>
<input type="date" id="entryDate" onchange="loadData()">

<div style="overflow-x:auto;">
<table id="entryTable">
  <thead>
    <tr>
      <th>जिन्स</th>
      <th>पर्चे संख्या</th>
      <th>मात्रा (बोरी)</th>
      <th>मात्रा (कु.)</th>
      <th>न्यूनत्तम</th>
      <th>मॉडल</th>
      <th>अधिकत्तम</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<p id="totalBori">Total Bori: 0</p>
<p id="totalQtl">Total Quintal: 0</p>

<button onclick="addRow()">नई Row जोड़ें</button>
<button onclick="submitData()">Submit / Update</button>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwAFHth2kD11WsxLhYcVEGd-QA6b7ETVl-2x86AixA/dev"; // Replace with deployed Apps Script URL
let jinsList = []; // [{name:"गेहूँ", qtl:1}, ...]

// Set today date
document.getElementById("entryDate").valueAsDate = new Date();

// Load jins list with conversion factor
fetch(WEB_APP_URL+"?action=getJins")
.then(res=>res.json())
.then(data=>{
  // data.jins = [{name:"गेहूँ", qtl:1}, ...]
  jinsList = data.jins;
  loadData(); // Load today's data by default
})
.catch(err=>console.error(err));

// Load existing data for selected date
function loadData(){
  const date = document.getElementById("entryDate").value;
  const tbody = document.querySelector("#entryTable tbody");
  tbody.innerHTML = "";
  if(!date) return;

  fetch(`${WEB_APP_URL}?action=getData&date=${date}`)
    .then(res=>res.json())
    .then(data=>{
      if(data.data.length===0) addRow(); // empty row if no data
      data.data.forEach(row=>addRow(row));
    })
    .catch(err=>console.error(err));
}

// Add new row
function addRow(data = {}){
  const tbody = document.querySelector("#entryTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <select onchange="updateQuintalOnChange(this)">${jinsList.map(j=>`<option value="${j.name}" ${data.jins===j.name?'selected':''}>${j.name}</option>`).join('')}</select>
    </td>
    <td><input type="number" value="${data.purche||''}" min="0"></td>
    <td><input type="number" value="${data.bori||''}" min="0" oninput="updateQuintal(this)"></td>
    <td><input type="number" value="${data.qtl||''}" readonly></td>
    <td><input type="number" value="${data.low||''}" min="0"></td>
    <td><input type="number" value="${data.modal||''}" min="0"></td>
    <td><input type="number" value="${data.high||''}" min="0"></td>
    <td class="row-btn" onclick="deleteRow(this)">X</td>
  `;
  tbody.appendChild(tr);
  updateQuintal(tr.querySelector("td:nth-child(3) input"));
  updateTotals();
}

// Delete row
function deleteRow(el){ el.parentElement.remove(); updateTotals(); }

// Update Quintal when Bori changes
function updateQuintal(input){
  const tr = input.parentElement.parentElement;
  const bori = parseFloat(input.value)||0;
  const jinsName = tr.querySelector("select").value;
  const jinsObj = jinsList.find(j=>j.name===jinsName);
  const qtl = +(bori * (jinsObj?.qtl || 1)).toFixed(2);
  tr.querySelector("td:nth-child(4) input").value = qtl;
  updateTotals();
}

// Update Quintal if jins select changes
function updateQuintalOnChange(select){
  const tr = select.parentElement.parentElement;
  updateQuintal(tr.querySelector("td:nth-child(3) input"));
}

// Update totals
function updateTotals(){
  const rows = document.querySelectorAll("#entryTable tbody tr");
  let totalBori=0, totalQtl=0;
  rows.forEach(tr=>{
    totalBori += parseFloat(tr.querySelector("td:nth-child(3) input").value)||0;
    totalQtl += parseFloat(tr.querySelector("td:nth-child(4) input").value)||0;
  });
  document.getElementById("totalBori").textContent = "Total Bori: "+totalBori;
  document.getElementById("totalQtl").textContent = "Total Quintal: "+totalQtl.toFixed(2);
}

// Submit / Update data
function submitData(){
  const date = document.getElementById("entryDate").value;
  if(!date){ alert("दिनांक चुने"); return; }

  const rows = document.querySelectorAll("#entryTable tbody tr");
  if(rows.length==0){ alert("कोई row नहीं है"); return; }

  const dataToSend = [];
  rows.forEach(tr=>{
    dataToSend.push({
      date: date,
      jins: tr.querySelector("select").value,
      purche: tr.querySelector("td:nth-child(2) input").value,
      bori: tr.querySelector("td:nth-child(3) input").value,
      qtl: tr.querySelector("td:nth-child(4) input").value,
      low: tr.querySelector("td:nth-child(5) input").value,
      modal: tr.querySelector("td:nth-child(6) input").value,
      high: tr.querySelector("td:nth-child(7) input").value
    });
  });

  fetch(WEB_APP_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(dataToSend)
  })
  .then(res => res.json())
  .then(resp => {
    alert("Data Submitted/Updated Successfully!");
    loadData(); // refresh table
  })
  .catch(err => {
    alert("Error: " + err);
    console.error(err);
  });
}
</script>
</body>
</html>
