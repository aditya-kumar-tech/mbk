<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>SheopurMBK डेटा</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
h2, h3 { color: #333; }
table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 10px; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: center; }
th { background: #4CAF50; color: white; }
tr:nth-child(even) { background: #f9f9f9; }
input, select, button { padding: 6px; margin: 3px; border: 1px solid #ccc; border-radius: 4px; }
button { background: #4CAF50; color: white; border: none; cursor: pointer; }
button:hover { background: #45a049; }
tfoot td { font-weight: bold; background: #eee; }
.action-btn { margin: 0 2px; padding: 4px 8px; font-size: 12px; }
.editing { background: #fffae6; }
.form-box { background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; }
#errorMsg { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>SheopurMBK डेटा</h2>

<div id="errorMsg"></div>

<!-- Entry Form -->
<div class="form-box">
  <h3>नई एंट्री</h3>
  <form id="entryForm">
    दिनांक: <input type="date" id="दिनांक" required>  
    जिन्स: <select id="जिन्स"></select><br>
    पर्चे संख्या: <input type="number" id="पर्चे संख्या">
    मात्रा (बोरी): <input type="number" id="मात्रा (बोरी)" step="0.01">
    मात्रा (कु.): <input type="number" id="मात्रा (कु.)" step="0.01"><br>
    न्यूनत्तम: <input type="number" id="न्यूनत्तम" step="0.01">
    मॉडल: <input type="number" id="मॉडल" step="0.01">
    अधिकत्तम: <input type="number" id="अधिकत्तम" step="0.01"><br>
    <button type="submit">Save</button>
  </form>
</div>

<!-- Filter & Load -->
<label>दिनांक से खोजें:</label>
<input type="date" id="searchDate">
<button onclick="loadFiltered()">खोजें</button>
<button onclick="loadAll()">डेटा लोड करें</button>

<h3>डेटा सूची</h3>
<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th><th>दिनांक</th><th>जिन्स</th><th>पर्चे संख्या</th>
      <th>मात्रा (बोरी)</th><th>मात्रा (कु.)</th>
      <th>न्यूनत्तम</th><th>मॉडल</th><th>अधिकत्तम</th><th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="3">कुल</td>
      <td id="totalParche">0</td>
      <td id="totalBori">0</td>
      <td id="totalKu">0</td>
      <td colspan="4"></td>
    </tr>
  </tfoot>
</table>

<script>
const api = "https://script.google.com/macros/s/AKfycbwZjNymnBi7-yqhzMtHeHfsTiKUDZcngjaWL1GL7MsKjRwiyJaH9nU7D1hMiOKxFuhh/exec"; // अपने Web App का exec URL डालें

// ====== Dropdown Loader with Logs ======
async function loadJinsList() {
  const errorBox = document.getElementById("errorMsg");
  errorBox.textContent = "";
  try {
    console.log("Fetching JINS list from:", `${api}?action=getJinsList`);
    const res = await fetch(`${api}?action=getJinsList`);
    console.log("Response status:", res.status);

    const raw = await res.text();
    console.log("Raw response text:", raw);

    let jinsArray;
    try {
      jinsArray = JSON.parse(raw);
    } catch (e) {
      console.error("JSON parse error:", e);
      errorBox.textContent = "❌ JINS list JSON parse error";
      return;
    }

    console.log("Parsed JINS Array:", jinsArray);

    const jinsSelect = document.getElementById("जिन्स");
    jinsSelect.innerHTML = "";
    if (Array.isArray(jinsArray) && jinsArray.length > 0) {
      jinsArray.forEach(jins => {
        const opt = document.createElement("option");
        opt.value = jins;
        opt.textContent = jins;
        jinsSelect.appendChild(opt);
      });
    } else {
      console.warn("⚠ JINS array empty");
      errorBox.textContent = "⚠ JINS array empty (backend returned no data)";
    }
  } catch (err) {
    console.error("Fetch error for JINS list:", err);
    errorBox.textContent = "❌ Failed to fetch JINS list";
  }
}

// ====== Date Format ======
function formatDateIndian(dateStr) {
  if(!dateStr) return "";
  let dateObj = new Date(dateStr);
  if (isNaN(dateObj)) return dateStr;
  return dateObj.toLocaleDateString('en-GB');
}

// ====== Render Table ======
function renderTable(data) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  let totalParche = 0, totalBori = 0, totalKu = 0;

  data.forEach(row => {
    totalParche += Number(row["पर्चे संख्या"]) || 0;
    totalBori += Number(row["मात्रा (बोरी)"]) || 0;
    totalKu += Number(row["मात्रा (कु.)"]) || 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${formatDateIndian(row["दिनांक"])}</td>
      <td>${row["जिन्स"]}</td>
      <td>${row["पर्चे संख्या"]}</td>
      <td>${row["मात्रा (बोरी)"]}</td>
      <td>${row["मात्रा (कु.)"]}</td>
      <td>${row["न्यूनत्तम"]}</td>
      <td>${row["मॉडल"]}</td>
      <td>${row["अधिकत्तम"]}</td>
      <td>
        <button onclick='editRow(this)'>Edit</button>
        <button style="background:#d9534f" onclick='deleteRow("${row.id}")'>Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("totalParche").innerText = totalParche;
  document.getElementById("totalBori").innerText = totalBori;
  document.getElementById("totalKu").innerText = totalKu;
}

// ====== Load All Data Button ======
async function loadAll() {
  console.log("Loading all data...");
  const res = await fetch(api);
  const raw = await res.text();
  console.log("Raw all-data response:", raw);
  let data;
  try {
    data = JSON.parse(raw);
  } catch(e) {
    console.error("Error parsing all-data JSON:", e);
    return;
  }
  renderTable(data);
}

// ====== Load Filtered ======
async function loadFiltered() {
  const date = document.getElementById("searchDate").value;
  if (!date) return alert("कृपया दिनांक चुनें");
  console.log("Loading filtered data for date:", date);
  const res = await fetch(`${api}?action=getDataByDate&date=${encodeURIComponent(date)}`);
  const raw = await res.text();
  console.log("Raw filtered-data response:", raw);
  let data;
  try {
    data = JSON.parse(raw);
  } catch(e) {
    console.error("Error parsing filtered-data JSON:", e);
    return;
  }
  renderTable(data);
}

// ====== Inline Edit ======
function editRow(btn) {
  const tr = btn.closest("tr");
  if (tr.classList.contains("editing")) return;
  tr.classList.add("editing");
  for (let i = 1; i <= 8; i++) { 
    let cell = tr.cells[i];
    let val = cell.innerText;
    if (i === 1) { // date
      let parts = val.split("/");
      if (parts.length === 3) {
        val = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
      }
      cell.innerHTML = `<input type="date" value="${val}">`;
    } else {
      cell.innerHTML = `<input type="text" value="${val}">`;
    }
  }
  btn.innerText = "Save";
  btn.onclick = () => saveRow(tr, btn);
}

async function saveRow(tr, btn) {
  const id = tr.cells[0].innerText;
  const record = {
    id: id,
    "दिनांक": tr.cells[1].querySelector("input").value,
    "जिन्स": tr.cells[2].querySelector("input").value,
    "पर्चे संख्या": tr.cells[3].querySelector("input").value,
    "मात्रा (बोरी)": tr.cells[4].querySelector("input").value,
    "मात्रा (कु.)": tr.cells[5].querySelector("input").value,
    "न्यूनत्तम": tr.cells[6].querySelector("input").value,
    "मॉडल": tr.cells[7].querySelector("input").value,
    "अधिकत्तम": tr.cells[8].querySelector("input").value
  };
  console.log("Updating record:", record);
  const res = await fetch(`${api}?action=update&data=${encodeURIComponent(JSON.stringify(record))}`);
  const raw = await res.text();
  console.log("Update response:", raw);
  tr.classList.remove("editing");
 // loadAll();
}

// ====== Delete Row ======
async function deleteRow(id) {
  if (!confirm("क्या आप वाकई delete करना चाहते हैं?")) return;
  console.log("Deleting ID:", id);
  const res = await fetch(`${api}?action=delete&id=${id}`);
  const raw = await res.text();
  console.log("Delete response:", raw);
 // loadAll();
}

// ====== Add New Entry ======
document.getElementById("entryForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const record = {};
  ["दिनांक","जिन्स","पर्चे संख्या","मात्रा (बोरी)","मात्रा (कु.)","न्यूनत्तम","मॉडल","अधिकत्तम"].forEach(id => {
    record[id] = document.getElementById(id).value;
  });
  console.log("Adding new record:", record);
  const res = await fetch(`${api}?action=add&data=${encodeURIComponent(JSON.stringify(record))}`);
  const raw = await res.text();
  console.log("Add record response:", raw);
  document.getElementById("entryForm").reset();
  document.getElementById("दिनांक").value = new Date().toISOString().split('T')[0];
});

// ====== Init: Load only dropdown ======
document.getElementById("दिनांक").value = new Date().toISOString().split('T')[0];
loadJinsList();
</script>
</body>
</html>
