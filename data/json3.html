<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HTML Tables to District-wise JSON ZIP</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: sans-serif; padding:20px; background:#f7f7f7; display:flex; justify-content:center; }
.container { background:#fff; padding:25px; border-radius:8px; max-width:600px; width:100%; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
input,button { width:100%; padding:12px; margin-bottom:15px; font-size:1rem; border-radius:5px; }
button { background:#2e7d32; color:white; border:none; cursor:pointer; font-weight:700; }
button:hover { background:#1b4d20; }
pre { background:#eee; padding:15px; border-radius:5px; min-height:100px; overflow:auto; }
.download-btn { display:none; margin-top:10px; background:#1565c0; }
.download-btn:hover { background:#0d3c7a; }
</style>
</head>
<body>
<div class="container">
  <h2>HTML ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</h2>
  <input type="file" id="fileInput" accept=".xls,.xlsx,.html,.htm" multiple />
  <button id="btnProcess">Convert & Download ZIP</button>
  <pre id="log"></pre>
  <button id="btnDownloadSDM" class="download-btn">Download Missing SDM Excel</button>
  <button id="btnDownloadCVG" class="download-btn">Download Missing Commodity/Variety/Grade Excel</button>
</div>

<script>
(() => {
const baseUrl = "https://aditya-kumar-tech.github.io/mbk";
const fileInput = document.getElementById("fileInput");
const btnProcess = document.getElementById("btnProcess");
const logEl = document.getElementById("log");
const btnDownloadSDM = document.getElementById("btnDownloadSDM");
const btnDownloadCVG = document.getElementById("btnDownloadCVG");

let missedSDM = [];
let missedCVG = [];

// Fetch JSON
async function fetchJson(url){ const res = await fetch(url); return res.json(); }

// Slug function
function toSlug(name){
    name = name.replace(/[\u200B-\u200D\uFEFF]/g,"").trim();
    if(/\(F&V\)/i.test(name)){ name = name.toLowerCase().replace(/\s*\(F&V\)\s*/gi,"_fv").replace(/[()]/g,"").replace(/[^\w\s_]/g,"").replace(/\s+/g,"_"); return name; }
    name = name.toLowerCase().replace(/\(\s*([^)]+)\s*\)/g,"_$1").replace(/[^\w\s_]/g,"").replace(/\s+/g,"_");
    return name;
}

// Extract state
function extractStateName(titleText){
    titleText = titleText.replace(/<[^>]*>/g,"").trim();
    const match = titleText.match(/from\s+(.+?)\s+from/i);
    return match && match[1] ? match[1].trim() : "Unknown_State";
}

// Parse HTML table
function parseHTML(content, filename){
    const parser = new DOMParser();
    const doc = parser.parseFromString(content,"text/html");
    const table = doc.querySelector("table");
    if(!table) throw new Error(`Table not found in ${filename}`);
    return [...table.querySelectorAll("tr")].map(tr=>[...tr.querySelectorAll("th,td")].map(td=>td.textContent.trim()));
}

// Format date
function formatDate(dateStr){
    if(!dateStr) return "";
    const months = {"Jan":"01","Feb":"02","Mar":"03","Apr":"04","May":"05","Jun":"06","Jul":"07","Aug":"08","Sep":"09","Oct":"10","Nov":"11","Dec":"12"};
    let parts = dateStr.split(" ");
    if(parts.length!==3) return dateStr;
    return `${parts[2]}-${months[parts[1]]||"01"}-${parts[0].padStart(2,"0")}`;
}

// Main processing
btnProcess.addEventListener("click", async ()=>{
    const files = fileInput.files;
    if(!files.length){ alert("‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç"); return; }

    logEl.textContent = "üïê Processing...\n";
    const zip = new JSZip();
    missedSDM = [];
    missedCVG = [];

    const [commodityJson, varietyJson, gradeJson, statesJson] = await Promise.all([
        fetchJson(`${baseUrl}/data/hi/commodityEng.json`),
        fetchJson(`${baseUrl}/data/hi/varieties.json`),
        fetchJson(`${baseUrl}/data/hi/grades.json`),
        fetchJson(`${baseUrl}/data/hi/states.json`)
    ]);

    for(const file of files){
        logEl.textContent += `\nüìÇ ${file.name}`;
        const content = await file.text();
        let tableRows;
        try { tableRows = parseHTML(content,file.name); } 
        catch(err){ logEl.textContent += `\n‚ùå ${err.message}`; continue; }

        const titleText = content.slice(0,content.indexOf("<table"));
        const stateName = extractStateName(titleText);
        const stateSlug = toSlug(stateName);
        const stateFolder = zip.folder(stateSlug);

        let distJson = {}, mandiJson = {};
        try {
            distJson = await fetchJson(`${baseUrl}/data/hi/dists/${stateSlug}.json`);
            mandiJson = await fetchJson(`${baseUrl}/data/hi/mandis/${stateSlug}_mandis.json`);
        } catch(e){ logEl.textContent += `\n‚ùå JSON load error for ${stateName}`; continue; }

        const headers = ["date","mandi_id","commodity_id","variety_id","grade_id","min_price","max_price","modal_price","arrival_quintal","arrival_bori"];
        const districtDataMap = {};

        tableRows.slice(1).forEach((row,index)=>{
            if(row.length<5) return;
            const date = row[9] || "";
            const districtName = row[1];
            const mandiName = row[2];
            const commodityName = row[3];
            const varietyName = row[4];
            const gradeName = row[5];
            const minPrice = row[6] || 0;
            const maxPrice = row[7] || 0;
            const modalPrice = row[8] || 0;

            // SDM check
            const distSlug = toSlug(districtName);
            const distEntry = Object.entries(distJson.data||{}).find(([k,v])=>v[1]===distSlug);
            const distId = distEntry?distEntry[0]:null;
            const mandiSlug = toSlug(mandiName);
            const mandiEntry = Object.entries(mandiJson.data||{}).find(([k,v])=>v[1]===mandiSlug);
            const mandiId = mandiEntry?mandiEntry[0]:null;

            if(!distId || !mandiId){
                missedSDM.push({State:stateName,Row:index+1,District:districtName,Mandi:mandiName,Reason:!distId?"District Missing":"Mandi Missing"});
                return;
            }

            // CVG check
            const commodityId = Object.keys(commodityJson).find(k=>commodityJson[k]===commodityName);
            if(!commodityId){ missedCVG.push({Commodity:commodityName,Variety:varietyName,Grade:gradeName,Status:"Missing Commodity"}); return; }

            const varietyId = Object.keys(varietyJson).find(k=>varietyJson[k].n===varietyName && varietyJson[k].cid===commodityId);
            if(!varietyId){ missedCVG.push({Commodity:commodityName,Variety:varietyName,Grade:gradeName,Status:"Missing Variety"}); return; }

            const gradeId = Object.keys(gradeJson).find(k=>gradeJson[k]===gradeName);
            if(!gradeId){ missedCVG.push({Commodity:commodityName,Variety:varietyName,Grade:gradeName,Status:"Missing Grade"}); return; }

            // JSON rows
            if(!districtDataMap[districtName]) districtDataMap[districtName]=[];
            districtDataMap[districtName].push([formatDate(date),mandiId,commodityId,varietyId||"0",gradeId||"0",parseFloat(minPrice)||0,parseFloat(maxPrice)||0,parseFloat(modalPrice)||0,0,0]);
        });

        for(const district in districtDataMap){
            const distFileName = `${toSlug(district)}_prices.json`;
            const jsonContent = {headers, rows:districtDataMap[district]};
            stateFolder.file(distFileName, JSON.stringify(jsonContent));
        }

        logEl.textContent += `\n‚úÖ ${file.name} done`;
    }

    // ZIP download (JSON)
    const blob = await zip.generateAsync({type:"blob"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "prices.zip";
    a.click();
    logEl.textContent += "\n\nüì¶ ZIP downloaded";

    // Show SDM download button
    if(missedSDM.length){ 
        logEl.textContent += `\n‚ö†Ô∏è ${missedSDM.length} State/District/Mandi missing. Click button to download Excel.`;
        btnDownloadSDM.style.display="block";
    }

    // Show CVG download button
    if(missedCVG.length){
        logEl.textContent += `\n‚ö†Ô∏è ${missedCVG.length} Commodity/Variety/Grade missing. Click button to download Excel.`;
        btnDownloadCVG.style.display="block";
    }
});

// SDM Excel download
btnDownloadSDM.addEventListener("click", ()=>{
    const wb = XLSX.utils.book_new();
    const wsData = [["State","Row Number","District","Mandi","Reason"], ...missedSDM.map(r=>[r.State,r.Row,r.District||"0",r.Mandi||"0",r.Reason])];
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb,ws,"Missing SDM");
    XLSX.writeFile(wb,"missing_sdm.xlsx");
});

// CVG Excel download
btnDownloadCVG.addEventListener("click", ()=>{
    const wb = XLSX.utils.book_new();
    const wsData = [["Commodity","Variety","Grade","Status"], ...missedCVG.map(r=>[r.Commodity,r.Variety,r.Grade,r.Status])];
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb,ws,"Missing CVG");
    XLSX.writeFile(wb,"missing_cvg.xlsx");
});
})();
</script>
</body>
</html>
