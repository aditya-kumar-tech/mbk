<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>SheopurMBK डेटा</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
h2, h3 { color: #333; }
table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 10px; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: center; }
th { background: #4CAF50; color: white; }
tr:nth-child(even) { background: #f9f9f9; }
input, select, button { padding: 6px; margin: 3px; border: 1px solid #ccc; border-radius: 4px; }
button { background: #4CAF50; color: white; border: none; cursor: pointer; }
button:hover { background: #45a049; }
tfoot td { font-weight: bold; background: #eee; }
.action-btn { margin: 0 2px; padding: 4px 8px; font-size: 12px; }
.editing { background: #fffae6; }
</style>
</head>
<body>

<h2>SheopurMBK डेटा</h2>

<label>दिनांक से खोजें:</label>
<input type="date" id="searchDate">
<button onclick="loadFiltered()">खोजें</button>
<button onclick="loadAll()">सभी दिखाएं</button>

<h3>डेटा सूची</h3>
<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th><th>दिनांक</th><th>जिन्स</th><th>पर्चे संख्या</th>
      <th>मात्रा (बोरी)</th><th>मात्रा (कु.)</th>
      <th>न्यूनत्तम</th><th>मॉडल</th><th>अधिकत्तम</th><th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="4">कुल</td>
      <td id="totalBori">0</td>
      <td id="totalKu">0</td>
      <td colspan="4"></td>
    </tr>
  </tfoot>
</table>

<script>
const api = "YOUR_WEB_APP_URL"; // यहाँ अपना WebApp URL लगाएं

async function loadAll() {
  const res = await fetch(api);
  const data = await res.json();
  renderTable(data);
}

async function loadFiltered() {
  const date = document.getElementById("searchDate").value;
  if (!date) return alert("कृपया दिनांक चुनें");
  const res = await fetch(`${api}?action=getDataByDate&date=${encodeURIComponent(date)}`);
  const data = await res.json();
  renderTable(data);
}

// तारीख Indian Format में
function formatDateIndian(dateStr) {
  if(!dateStr) return "";
  let dateObj = new Date(dateStr);
  if (isNaN(dateObj)) return dateStr; // अगर गलत date है
  return dateObj.toLocaleDateString('en-GB'); // DD/MM/YYYY
}

// टेबल रेंडर करना
function renderTable(data) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  let totalBori = 0;
  let totalKu = 0;

  data.forEach(row => {
    totalBori += Number(row["मात्रा (बोरी)"]) || 0;
    totalKu += Number(row["मात्रा (कु.)"]) || 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${formatDateIndian(row["दिनांक"])}</td>
      <td>${row["जिन्स"]}</td>
      <td>${row["पर्चे संख्या"]}</td>
      <td>${row["मात्रा (बोरी)"]}</td>
      <td>${row["मात्रा (कु.)"]}</td>
      <td>${row["न्यूनत्तम"]}</td>
      <td>${row["मॉडल"]}</td>
      <td>${row["अधिकत्तम"]}</td>
      <td>
        <button class="action-btn" onclick='editRow(this)'>Edit</button>
        <button class="action-btn" style="background:#d9534f" onclick='deleteRow("${row.id}")'>Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("totalBori").innerText = totalBori;
  document.getElementById("totalKu").innerText = totalKu;
}

// Inline edit
function editRow(btn) {
  const tr = btn.closest("tr");
  if (tr.classList.contains("editing")) return;

  tr.classList.add("editing");
  for (let i = 1; i <= 8; i++) { // ID को छोड़
    let cell = tr.cells[i];
    let val = cell.innerText;
    if (i === 1) { // दिनांक
      let parts = val.split("/");
      if (parts.length === 3) {
        val = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
      }
      cell.innerHTML = `<input type="date" value="${val}">`;
    } else {
      cell.innerHTML = `<input type="text" value="${val}">`;
    }
  }
  btn.innerText = "Save";
  btn.onclick = () => saveRow(tr, btn);
}

async function saveRow(tr, btn) {
  const id = tr.cells[0].innerText;
  const record = {
    id: id,
    "दिनांक": tr.cells[1].querySelector("input").value,
    "जिन्स": tr.cells[2].querySelector("input").value,
    "पर्चे संख्या": tr.cells[3].querySelector("input").value,
    "मात्रा (बोरी)": tr.cells[4].querySelector("input").value,
    "मात्रा (कु.)": tr.cells[5].querySelector("input").value,
    "न्यूनत्तम": tr.cells[6].querySelector("input").value,
    "मॉडल": tr.cells[7].querySelector("input").value,
    "अधिकत्तम": tr.cells[8].querySelector("input").value
  };

  const res = await fetch(`${api}?action=update&data=${encodeURIComponent(JSON.stringify(record))}`);
  const result = await res.json();
  if (result.status === "success") {
    tr.classList.remove("editing");
    loadAll();
  } else {
    alert("Error updating data");
  }
}

async function deleteRow(id) {
  if (!confirm("क्या आप वाकई delete करना चाहते हैं?")) return;
  const res = await fetch(`${api}?action=delete&id=${id}`);
  const result = await res.json();
  if (result.status === "success") {
    loadAll();
  } else {
    alert("Error deleting");
  }
}

loadAll();
</script>
</body>
</html>
